# Домашнее задание №1
#### Первичный анализ и предобработка данных
Основные статистики вещественных признаков для train:

| | year | selling_price | km_driven | seats |
| ------ | ------ | ------ | ------ | ------ |
| count | 6999.000000 |	6.999000e+03 |	6.999000e+03 |	6797.000000 |
| mean | 2013.818403 |	6.395152e+05 |	6.958462e+04 |	5.419008 |
| std |	4.053095 |	8.089419e+05 |	5.772400e+04 |	0.965767 |
| min |	1983.000000 |	2.999900e+04 |	1.000000e+00 |	2.000000 |
| 25% |	2011.000000 |	2.549990e+05 |	3.500000e+04 |	5.000000 |
| 50% |	2015.000000	| 4.500000e+05 | 6.000000e+04 |	5.000000 |
| 75% |	2017.000000 | 6.750000e+05 | 9.700000e+04 |	5.000000 |
| max |	2020.000000 | 1.000000e+07 | 2.360457e+06 |	14.000000 |

Основные статистики категориальных признаков для train:

|	| name | fuel |	seller_type | transmission | owner |	mileage |	engine |	max_power |	torque |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| count | 6999 | 6999| 6999| 6999|	6999 | 6797 | 6797 | 6803 |	6796 |
| unique| 1924|	4 |	3 |	2 |	5 |	386 | 120 |	316 | 419 |
| top|	Maruti Swift Dzire VDI | Diesel | Individual | Manual |	First Owner | 18.9 kmpl | 1248 CC | 74 bhp | 190Nm@ 2000rpm |
| freq|	116 | 3793 | 5826 |	6095 | 4587 | 197 |	885 | 330 |	468 |

Основные статистики вещественных признаков для test:

| | year | selling_price | km_driven | seats |
| ------ | ------ | ------ | ------ | ------ |
| count | 1000.000000 |	1.000000e+03 |	1000.000000 |	981.000000 |
| mean | 2013.681000 |	6.179010e+05 |	71393.341000 |	5.410805 |
| std |	4.012149 |	7.585539e+05 |	48486.218662 |	0.919985 |
| min |	1995.000000 |	3.100000e+04 |	1303.000000 |	4.000000 |
| 25% |	2011.000000 |	2.500000e+05 |	37000.000000 |	5.000000 |
| 50% |	2014.000000 |	4.349990e+05 |	61500.000000 |	5.000000 |
| 75% |	2017.000000 |	6.700000e+05 |	100000.000000 |	5.000000 |
| max |	2020.000000 |	6.000000e+06 |	375000.000000 |	9.000000 |

Основные статистики категориальных признаков для test:

|	| name | fuel |	seller_type | transmission | owner |	mileage |	engine |	max_power |	torque |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| count | 1000 | 1000| 1000| 1000|	1000 | 981 | 981 | 981 |	981 |
| unique| 621 |	4 |	3 |	2 |	5 |	237 | 88 | 182 | 226 |
| top|	Maruti Alto 800 LXI | Diesel | Individual | Manual |	First Owner | 18.6 kmpl | 1248 CC | 74 bhp | 200Nm@ 1750rpm |
| freq|	15 | 534 |	837 | 877 |	623 | 23 | 116 | 43	| 57 |


Признаки, которые имеют пропуски в train:
* mileage - 2.886%
* engine - 2.886%
* max_power - 2.8%
* torque - 2.9%
* seats - 2.886%

Признаки, которые имеют пропуски в train:
* mileage - 1.9%
* engine - 1.9%
* max_power - 1.9%
* torque - 1.9%
* seats - 1.9%

1. Из train были удалены повторяющиеся строки
2. Также были удалены единцы измерения признаков mileage, engine, max_power в обоих датасетах
3. Пропуски в столбцах были заполнены медианами из датасета train

#### Визуализации
1. Были постороены попарные распределения всех числовых признаков для train и test
2. А также heatmap для train

Были выявлены наиболее и наименее скоррелированные признаки:
* Наименее скоррелированными между собой признаками оказались **engine - year** и **max_power - km_driven**
* Сильная положительная зависимость наблюдается между **max_power - engine** и **seats - engine**

#### Обучение моделей
##### 1. Модель только на вещественных признаках
###### 1.1 Обучение классической линейной регрессии с дефолтными параметрами
При обучении моедли с дефолтными параметрами после стандартизации только на вещественных признаках каечтво модели на метриках R2 и MSE получилось:
* Для train:
MSE: 116874154636.75668
R2 score: 0.5922591677501573

* Для test:
MSE: 233298782152.40558
R2 score: 0.5941419752654984

Также была оценена значимось кажой фичи по вычисленным весам модели:
|features |	feature_importances | feature_importances_abs |
| ------ | ------ | ------ |
| max_power | 322807.349335 | 322807.349335 |
| year | 152772.568945 | 152772.568945 |
| engine |	61178.502353 |	61178.502353 |
| km_driven |	-44158.819342 |	44158.819342 |
| mileage |	28833.930652 |	28833.930652 |
| seats |-23209.134345 |	23209.134345 |

Самым значимым признаком оказалась max_power.
###### 1.2 Обучение Lasso-регрессии с дефолтными параметрами
* Для train:
MSE: 116874154646.87068
R2 score: 0.5922591677148724

* Для test:
MSE: 233299453021.15195
R2 score: 0.5941408081892636

Полученные значение скоров практически не отличаются от значений классической линейной регрессии.
С параметрами по умолчанию Lasso не обнулила веса, следовательно все эти признаки являются значимыми при alpha = 1.
###### 1.3 Обучение Lasso-регрессии с подобранными GridSearchCV параметрами
Лучшими параметры после обучения GridSearchCV оказались:
* alpha: 4996
* fit_intercept: True
* selection: cyclic

После обучения с такими параметрами результаты даже немного ухудшились. Веса менее значимых признаков не обнулились, но уменьшились по модулю.
* Для train:
MSE: 117121468550.49101
R2 score: 0.5913963595328366

* Для test:
MSE: 236892268669.12125
R2 score: 0.587890569552495

###### 1.4 Обучение ElasticNet с подобранными GridSearchCV параметрами
Лучшими параметры после обучения GridSearchCV оказались:
* alpha: 1
* l1_ratio: 0.9
* selection: random

Значение гиперпараметра l1_ratio = 0.9 говорит о том, что лучше использовать L2-регуляризацию.
После обучения с такими параметрами результаты ухудшились сильнее.
* Для train 
MSE: 117993442691.61311
R2 score: 0.5883542886566324

* Для test 
MSE: 245894601702.7578
R2 score: 0.5722296686711219

##### 2. Добавление категориальных признаков
После добавления категориальных фич и применения OneHot-кодирования, а затем стандартизации и подбора оптимальных параметров было проведено обучение гребневой (Ridge) регрессии.
Лучшими параметры после обучения GridSearchCV оказались:
* alpha: 499

После обучения с такими параметрами и применением L2-регуляризации результаты улучшились.
* Для train:
MSE: 101179730661.52701
R2 score: 0.6470125690751195

* Для test:
MSE: 224703346690.33932
R2 score: 0.6090950171381653

#### Feature Engineering
1. Добавлены dummy-столбецы для модели, сигнализирующие, что раньше на месте медианы был пропуск
2. Добавлен новый признак год в квадрате вместо просто года, так как зависимость цены от года выглядит квадратичной, а не линейной
3. Добавлен новый признак число "лошадей" на литр объема.
4. Распределение пробега оказалось не нормальным, поэтому было принято решение добавить новый признак **log_km_driven** - прологарифмированных пробег
5. Также был добавлен пороговый признак "владелец третий или больше"

#### Обучение финальной модели
Наилучший результат показала Ridge-регрессия, поэтому было принято решение после feature engineering-a обучать ее.
Лучшими параметры после обучения GridSearchCV оказались:
* alpha: 19

После обучения с результаты заметно улучшились.
* Для train:
MSE: 95300010603.3016
R2 score: 0.6675252474973764

* Для test:
MSE: 207130336771.77658
R2 score: 0.6396658886548819

Также была рассчитана кастомная метрика - среди всех предсказанных цен на авто рассчитана долю предиктов, отличающихся от реальных цен на эти авто не более чем на 10% (в одну или другую сторону).
Доля отличающихся предиктов не более чем на 10%: 0.211
Что не самых хороший результат :(

#### Реализация сервиса на FastAPI
Был реализован сервис на FastAPI, который с точки зрения пользователя реализует две функции:
* На вход в формате json подаются признаки одного объекта, на выходе сервис выдает предсказанную стоимость машины screenshot
* На вход подается csv-файл с признаками тестовых объектов, на выходе получаем файл с +1 столбцом - предсказаниями на этих объектах

[Скрин1]([http://baidu.com/pic/doge.png](https://github.com/shiryaevva/HW_ML/blob/main/lib/fast_api1.png))
[Скрин2]([[http://baidu.com/pic/doge.png](https://github.com/shiryaevva/HW_ML/blob/main/lib/fast_api1.png](https://github.com/shiryaevva/HW_ML/blob/main/lib/fast_api2.png))














